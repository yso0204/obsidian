## 운영체제란?
> 모든 프로그램을 HW를 필요로 하고 여기서 실행할 프로그램에 필요한 자원을 할당하고, 프로그램이 올바르게 실행되도록 돕는 프로그램이 운영체제 이다.

운영체제 역시 메모리에 적재되는데, 다른 프로그램과는 다르게 **커널영역** 에 적재된다.
커널 영역을 제외한 사용자가 이용하는 응용 프로그램들이 적재되는 공간을 **사용자 영역** 이라고 한다.

OS는 이러한 응용 프로그램들을 메모리에 주소가 겹치지 않게 적재하고 삭제하며, 각 프로그램들이 사용할 CPU 자원을 할당, 동시에 입출력장치를 사용하지 않도록 제어하는 등 마치 정부와 같은 역할을 한다.

## 운영체제의 심장, 커널
> 자원 접근과 제어, 프로그램의 올바른 실행 등의 핵심 서비스를 담당

### 이중 모드와 시스템 호출
- 응용 프로그램들이 각자 메모리에 접근, CPU자원을 마음대로 사용하려고 하면 충돌이 생긴다. 이를 위해 OS가 해당 기능들을 요청받아 실행한다.
#### 이중모드
> 이중모드란 CPU가 명령어를 실해하는 모드를 사용자 모드 / 커널 모드로 구분하는 방식

- 시스템 모드 : 운영체제 서비스를 제공받을 수 없는 실행 모드
- 커널 모드 : 운영체제 서비스를 제공받을 수 있는 실행 모드
![](https://i.imgur.com/YuDu8es.png)

#### 시스템 호출
> 사용자 모드로 실행되는 프로그램이 자원에 접근하는 OS 서비스를 제공받기 위해서는 운영체제에 요청을 보내 커널 모드로 전환되어야 한다. 이 요청을 시스템 호출이라고 한다.

시스템 호출 (System Call)은 SW 인터럽트며, CPU가 시스템 호출을 처리하는 순서는 일반적인 인터럽트 수행과 유사

## OS의 핵심 서비스
#### 프로세스 관리
> 실행 중인 프로그램을 프로세스라고 하며, CPU는 한번에 하나의 프로세르를 실행할 수 있기에 프로세스들을 번갈아 가며 실행함.

#### 자원 접근 및 할당
> 모든 프로세스는 실행을 위해 자원이 필요하고, OS는 프로세스들이 사용할 자원에 접근, 조작하여 프로세스들에 필요한 자원을 할당

- CPU : CPU 스케줄링을 통해 프로세스들에 CPU 자원을 할당
- 메모리 : 프로세스가 어느 주소에 적재될지 결정
- 입출력 장치 : CPU가 인터럽트 요청들을 처리할 수 있도록 인터럽트 서비스 루틴을 제공
### 파일 시스템 관리
> 파일들을 read, write, delete , 그리고 directory 로 관리

### 가상 머신과 하이퍼바이저 모드
> 가상머신(VMware 등)은 사용자 모드로 동작한다. 그럼 guest OS는 어떻게 시스템 자원에 접근할까?

초창기 가상 머신은 사용자 모드에서 실행되어 성능,안정성 문제로 커널 모드의 명령어를 직접 실행시킬 수 없는 문제가 있었다. 이를 위해 CPU 가상화(VT-x, AMD-v)기술이 도입되었고 이를 하이퍼바이저 모드라 한다.

- 사용자 모드(Ring 3) : application 실행
- 커널 모드(Ring 0) : OS 커널 실행
- 하이퍼바이저 모드(Ring -1) : 가상머신을 관리하는 최상위 모드
 
CPU 최상위 모드에서 실행 되어 OS가 커널 모드로 동작하더라도, HW 리소스를 통제할 수 있다.

#### 커널모드와 하이퍼바이저 모드가 동시 호출되면?
- CPU는 한번에 하나의 명령어만 실행 가능
- 동시 호출 보다는, 어떤 명령이 들어와서 하이퍼바이저가 먼저 개입해서 실행을 관리한다 라는 개념으로 생각
	- 커널모드에서 실행 중인데, 하이퍼 바이저가 개입하는 경우
		1. 프로세스가 실행중
		2. 시스템 호출 발생
		3. CPU가 HW 접근을 시도
			- 가상화 환경에서는 하이퍼바이저가 먼저 개입하여 우선 순위를 정하고 커널에게 넘길지를 결정
- 커널 모드에서 실행 중이더라도, CPU가 중요한 시스템 리소스를 제어하려고 하면 하이퍼바이저가 먼저 개입해서 실행을 조정
- 즉, CPU가 실행할 명령이 들어오면, 하이퍼바이저가 가장 먼저 처리한 후 커널 모드를 실핼할지 결정
##### 하이버 바이저가 개입하는 순간
1. Guest OS (Windows VM)에서 파일을 읽으려고 함 (Ring 3)  
	- 시스템 호출 발생
2. Guest OS 커널이 이 요청을 처리하기 위해 Ring 0으로 전환  
	- 실제 하드웨어에 접근하려고 함  
3.  하지만 Guest OS는 실제 하드웨어를 직접 만질 수 없음  
	- CPU의 **VT-x(하드웨어 가상화)가 감지하고, 하이퍼바이저(Ring -1)로 제어권을 넘김**  
4. 하이퍼바이저가 "이 요청을 처리해도 되는지" 확인  
	- 가능하면 가상화된 하드웨어(예: 가상 디스크)에서 처리  
	- 직접 처리할 수 없으면, Host OS 커널(Ring 0)에게 넘김  
5.  Host OS 커널이 파일 시스템에서 실제 파일을 읽고, 응답을 반환  
6.  Guest OS 커널과 애플리케이션이 결과를 받음

